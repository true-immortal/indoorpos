<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Indoor Navigation</title>
    <style>
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #000;
            position: relative;
            background: url('your-floorplan-image.jpg') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }
        .device {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: blue;
            border-radius: 50%;
        }
        #debug {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Indoor Navigation System using BLE</h1>
    <div id="map"></div>
    <button id="scanBLE">Start Scanning for BLE Devices</button>
    <button id="clearMap">Clear Map</button>
    <div id="debug"></div>

    <script>
        // Ensure Web Bluetooth API is available
        if (!navigator.bluetooth) {
            document.getElementById('debug').innerHTML = 'Web Bluetooth API not supported.';
        }

        const map = document.getElementById('map');
        const mapWidth = map.offsetWidth;
        const mapHeight = map.offsetHeight;

        // Function to start scanning for BLE devices
        async function scanBLEDevices() {
            try {
                // Request device
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [] // Specify services if needed
                });

                // Connect to the device
                const server = await device.gatt.connect();
                document.getElementById('debug').innerHTML = `Connected to: ${device.name}`;

                // Get primary services
                const services = await server.getPrimaryServices();
                services.forEach(async (service) => {
                    const characteristics = await service.getCharacteristics();
                    characteristics.forEach(characteristic => {
                        if (characteristic.properties.notify) {
                            characteristic.startNotifications();
                            characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
                        }
                    });
                });

                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('debug').innerHTML += '<br>Device disconnected.';
                });

            } catch (error) {
                handleError(error);
            }
        }

        // Handle characteristic value changes
        function handleCharacteristicValueChanged(event) {
            const characteristic = event.target;
            const value = characteristic.value;
            
            const rssi = parseRSSI(value); // Function to extract RSSI from characteristic value
            
            updateDeviceMarker(rssi);
        }

        // Function to parse RSSI from characteristic value
        function parseRSSI(value) {
            return value.getInt8(0); // Example: adapt based on actual BLE data format
        }

        // Update device marker based on RSSI value
        function updateDeviceMarker(rssi) {
            const distance = calculateDistanceFromRSSI(rssi);

            const x = Math.random() * mapWidth; // Replace with actual x-coordinate calculation
            const y = Math.random() * mapHeight; // Replace with actual y-coordinate calculation

            const deviceMarker = document.createElement('div');
            deviceMarker.className = 'device';
            deviceMarker.style.left = `${x}px`;
            deviceMarker.style.top = `${y}px`;
            map.appendChild(deviceMarker);

            document.getElementById('debug').innerHTML += `<br>Device RSSI: ${rssi}, Position: X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;
        }

        // Convert RSSI to distance
        function calculateDistanceFromRSSI(rssi) {
            const txPower = -59;
            if (rssi === 0) return -1.0;
            const ratio = rssi * 1.0 / txPower;
            if (ratio < 1.0) return Math.pow(ratio, 10);
            else {
                const distance =  (0.89976) * Math.pow(ratio, 7.7095) + 0.111;
                return distance;
            }
        }

        // Enhanced error handling
        function handleError(error) {
            console.log('Error:', error);
            document.getElementById('debug').innerHTML = `Error: ${error.message}`;
        }

        // Handle scanning for BLE devices
        document.getElementById('scanBLE').addEventListener('click', scanBLEDevices);

        // Clear map markers
        document.getElementById('clearMap').addEventListener('click', () => {
            const markers = document.querySelectorAll('.device');
            markers.forEach(marker => marker.remove());
        });
    </script>
</body>
</html>
