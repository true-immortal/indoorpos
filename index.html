<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor Navigation System</title>
    <style>
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #000;
            position: relative;
            background: url('your-floorplan-image.jpg') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }
        .marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
        #debug {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Indoor Navigation System</h1>
    <div id="map"></div>
    <button id="startTracking">Start Tracking</button>
    <button id="stopTracking">Stop Tracking</button>
    <div id="debug"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let tracking = false;
            let lastPosition = { x: 100, y: 100 }; // Initial position in pixels
            const map = document.getElementById('map');
            const mapWidth = map.offsetWidth;
            const mapHeight = map.offsetHeight;

            // Calibration and filter parameters
            const calibration = {
                accOffsetX: 0,
                accOffsetY: 0,
                accOffsetZ: 0,
                gyroOffsetAlpha: 0,
                gyroOffsetBeta: 0,
                gyroOffsetGamma: 0
            };

            const movementThreshold = 0.2; // Minimum movement to consider as significant
            const updateInterval = 100; // Update interval in milliseconds

            // Low-pass filter for smoothing
            const lowPassFilter = (value, previousValue, alpha) => {
                return alpha * value + (1 - alpha) * previousValue;
            };

            const updatePosition = (x, y) => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = `${x}px`;
                marker.style.top = `${y}px`;
                map.appendChild(marker);
            };

            const handleDeviceMotion = (event) => {
                if (!tracking) return;

                const acceleration = event.accelerationIncludingGravity;
                const gyro = event.rotationRate;

                // Calibration
                const accX = acceleration.x - calibration.accOffsetX;
                const accY = acceleration.y - calibration.accOffsetY;

                // Apply low-pass filter to smooth data
                const filteredAccX = lowPassFilter(accX, lastPosition.x, 0.2);
                const filteredAccY = lowPassFilter(accY, lastPosition.y, 0.2);

                // Apply movement detection
                const ax = Math.abs(filteredAccX) > movementThreshold ? filteredAccX : 0;
                const ay = Math.abs(filteredAccY) > movementThreshold ? filteredAccY : 0;

                // Update position
                lastPosition.x += ax * updateInterval / 1000;
                lastPosition.y += ay * updateInterval / 1000;

                // Boundary handling
                if (lastPosition.x < 0) lastPosition.x = 0;
                if (lastPosition.x > mapWidth) lastPosition.x = mapWidth;
                if (lastPosition.y < 0) lastPosition.y = 0;
                if (lastPosition.y > mapHeight) lastPosition.y = mapHeight;

                // Update marker position on map
                updatePosition(lastPosition.x, lastPosition.y);

                // Debugging output
                document.getElementById('debug').innerHTML = `
                    Acceleration: X: ${filteredAccX.toFixed(2)}, Y: ${filteredAccY.toFixed(2)}<br>
                    Position: X: ${lastPosition.x.toFixed(2)}, Y: ${lastPosition.y.toFixed(2)}
                `;
            };

            window.addEventListener('devicemotion', handleDeviceMotion);

            document.getElementById('startTracking').addEventListener('click', () => {
                tracking = true;
            });

            document.getElementById('stopTracking').addEventListener('click', () => {
                tracking = false;
            });

            // Ensure correct initialization of position on page load
            updatePosition(lastPosition.x, lastPosition.y);
        });
    </script>
</body>
</html>
